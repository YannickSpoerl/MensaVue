<!DOCTYPE html>
<html>
<head>
    <!-- Vuetify-->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
</head>
<body>
<div id="mensavue">
    <v-app>
        <div>
        <v-autocomplete 
            v-model="selectedCity" 
            :items="cities"
            label="City"
            placeholder="Enter City" 
            prepend-icon="location_city">
        </v-autocomplete>
        </div>
        <div>
        <v-select 
            v-if="selectedCity"
            item-text="name"
            item-value="id"
            :items="selectedCanteens"
            v-model="selectedCanteen"
            prepend-icon="restaurant"
            placeholder="Choose Canteen"
            label="Canteen">
        </v-select>
        </div>
        <p v-if="!selectedCity">No city selected</p>
        <p v-if="!selectedCanteen">No canteen selected</p>
        <ul>
            <li v-for="date in allMeals" v-if="!date.closed">
                {{ date.date }}
                <ul>
                    <li v-for="meal in date.meals">{{ meal.name }}</li>
                </ul>
            </li>
            
        </ul>
    </v-app>
</div>
<!--Vuetify-->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->
<script>
    Vue.component('meallist', {
        props: ['meals'],
        template: 
        `<ul>
            <li v-for="meal in meals">
                {{ meal.name }}
                <ul>
                    <li v-for="note in meal.notes">{{ note }}</li>
                </ul>
            </li>
        </ul>`,
    })
    const app = new Vue({
        el: '#mensavue',
        data: {
            selectedCanteen: '',
            selectedCity: '',
            cities: [],
            canteens: [],
            allMeals: []
        },
        methods: {

            getCanteenPages: function(){
                var req = new XMLHttpRequest();
                req.open('GET', 'https://openmensa.org/api/v2/canteens/', false);
                req.send(null);
                return req.getResponseHeader('X-Total-Pages');
            },

            fetchAllCanteens: function(){
                const pages = this.getCanteenPages();
                for (let i = 1; i < pages; i++) {
                    fetch('https://openmensa.org/api/v2/canteens?page=' + i)
                        .then(resp => resp.json())
                        .then(page => this.canteens.push.apply(this.canteens, page))
                        .then( () => this.fetchCities())
                }
            },

            fetchCities: function() {
                var cityList = []
                this.canteens.forEach(c => {
                    if(!cityList.includes(c.city)){
                        cityList.push(c.city);
                    }
                });
                this.cities = cityList.sort();
            }
        },
        computed: {
            selectedCanteens: function(){
                sCanteens = [];
                this.allMeals = [];
                this.selectedCanteen = '';
                this.canteens.forEach(c => {
                    if (c.city == this.selectedCity) {
                        sCanteens.push(c);
                    }
                });
                return sCanteens;
            }
        },
        watch: {
            selectedCanteen: function(){
                fetch('https://openmensa.org/api/v2/canteens/' + this.selectedCanteen + '/meals/')
                    .then(resp => resp.json())
                    .then(response => this.allMeals = response);
            }
        },
        created () {
            this.fetchAllCanteens();
        }
    })
</script>
</body>
</html>